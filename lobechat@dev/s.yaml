# ------------------------------------
#   官方手册: https://docs.serverless-devs.com/user-guide/aliyun/#fc3
#   常见小贴士: https://manual.serverless-devs.com/user-guide/tips/
#   有问题快来钉钉群问一下吧：33947367
# ------------------------------------
edition: 3.0.0
name: lobechat-app
access: "root"

vars: 
  region: "cn-hangzhou"
  name: "lobechat_hxss" #这里的 name 是 project name，用于作为资源前缀
  functionName: "lobechat-up9g"
  imageUrl: registry.cn-hangzhou.aliyuncs.com/fc-demo2/ohyee-test:lobechat-database-v1
  bucketName: "ohyee-files"
  bucketEndpoint: "oss-cn-hangzhou.aliyuncs.com"

actions:
  complete-deploy:
    - component: fc3 invoke -e "{}" --silent

resources:
  PostgreSQL:
    component: rds
    props:
      region: "${vars.region}"
      name: "lobechat_pgsql_by_CAP"
      engine: "PostgreSQL:16.0"
      database: "lobechat_database"
      username: "cap"
      password: "AwesomeCAP_2024"
      vpcID: auto
      extensions:
        - name: vector

  LobeChat:
    component: fc3
    actions:
      complete-deploy:
        - component: fc3 invoke -e "{}" --silent
      pre-deploy:
        - run: bash ./base64-generation
            
    props:
      region: "${vars.region}" 
      functionName: "${vars.functionName}"
      description: "基于函数计算 FC 托管 LobeChat 应用"

      instanceConcurrency: 100
      cpu: 2
      memorySize: 4096
      diskSize: 512
      timeout: 600
      
      # 运行时
      runtime: custom-container
      customContainerConfig:
        port: 3210
        image: ${vars.imageUrl} 

      vpcConfig: 
          vpcId:  "${resources.PostgreSQL.props.vpcID}"
          securityGroupId: auto
          vSwitchIds: auto

      customDomain:
        protocol: "HTTP"
        route:
          path: "/*"
          qualifier: "LATEST"
        domainName: auto

      # 
      environmentVariables: 
        ACCESS_CODE: XXkBazqa0QjvZ5gbbbpUt+sEj1/dvjOMzBdfciEJJOk=
        QWEN_API_KEY: sk-3e0b34586f0b44e79dd6929e83d39e43
        APP_URL: "https://${vars.functionName}.fcv3.${config('AccountID')}.${vars.region}.fc.devsapp.net"
        AUTH_AUTH0_ID: tAP2ItjBX2L3NfoLLGxmlzrckboIZzok
        AUTH_AUTH0_ISSUER: https://dev-34fdqfx8mrw0s8t2.us.auth0.com
        AUTH_AUTH0_SECRET: KHaZpXbBGhE_AoNJP-2j47yaLP3nlqb77NFeCxkB4RzLPJ4Oeee-BdyxpaA0TnJH
        DATABASE_URL: "postgres://${resources.PostgreSQL.props.username}:${resources.PostgreSQL.props.password}@${resources.PostgreSQL.output.host}:5432/${resources.PostgreSQL.props.database}"
        DEFAULT_AGENT_CONFIG: "provider=qwen"
        KEY_VAULTS_SECRET: "20JvKLPOK6GoLE70vQA872OTUANMtD2RdykNlCiC8xs="
        NEXT_AUTH_SECRET: "01LI5H/BUhlUISBwj7oDhp5uExKEe+uUeN9KffrEs5I="
        NEXT_AUTH_SSO_PROVIDERS: "auth0"
        NEXT_PUBLIC_SERVICE_MODE: "server"
        NEXTAUTH_URL: "https://${vars.functionName}.fcv3.${config('AccountID')}.${vars.region}.fc.devsapp.net/api/auth"
        S3_ACCESS_KEY_ID: ${config('AccessKeyID')}
        S3_BUCKET: ${vars.bucketName}
        S3_ENDPOINT: "https://${vars.bucketEndpoint}"
        S3_PUBLIC_DOMAIN: "https://${vars.bucketName}.${vars.bucketEndpoint}"
        S3_REGION: ${vars.region}
        S3_SECRET_ACCESS_KEY: ${config('AccessKeySecret')}

      # 